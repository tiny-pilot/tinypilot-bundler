#!/bin/bash

# Creates a TinyPilot installation bundle from the bundle/ folder.
# Fetches all required dependencies automatically.

# Exit on first error.
set -e

# Exit on unset variable.
set -u

# Echo commands to stdout.
set -x

# TODO (jotaen): parameterize script to make the installation work for
#                TinyPilot Pro as well.
# TODO: Select the latest available version rather than hardcoding a specific
#       package.
readonly PKG_URL_TINYPILOT='https://bundles.tinypilotkvm.com/community/tinypilot-1.7.1-1-armhf.deb'
readonly REPO_ANSIBLE_TINYPILOT='https://github.com/tiny-pilot/ansible-role-tinypilot.git'
readonly REPO_ANSIBLE_NGINX='https://github.com/tiny-pilot/ansible-role-nginx'
readonly REPO_ANSIBLE_USTREAMER='https://github.com/tiny-pilot/ansible-role-ustreamer'

readonly BUNDLE_DIR='bundle'

pushd "${BUNDLE_DIR}"

wget "${PKG_URL_TINYPILOT}"

git clone \
  --depth 1 \
  --branch master \
  "${REPO_ANSIBLE_TINYPILOT}"

git clone \
  --depth 1 \
  --branch master \
  "${REPO_ANSIBLE_NGINX}"

git clone \
  --depth 1 \
  --branch master \
  "${REPO_ANSIBLE_USTREAMER}"

# Remove all `.git/` folders.
find . \
  -type d \
  -name .git \
  -prune \
  -exec rm -rf {} \;

popd

# Generate build output.
ls -lahR "${BUNDLE_DIR}" > dist/files.txt
tar \
  --create \
  --file dist/tinypilot.tar \
  --directory "${BUNDLE_DIR}" \
  .
